<?php require_once('_template_init.php'); ?>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Rechnungslauf</title>
    <link rel="stylesheet" type="text/css" href="/default.css">
</head>
<body>
    <?php @include('header.inc.html') ?>

    <h2>Rechnungslauf</h2>

    <form method="post">
        <input type="hidden" name="cmd" value="run">
        <table>
            <tr>
                <td>Datum:</td>
                <td><input type="date" name="datum" value="<?php safe_echo(post_value('datum', date('Y-m-d'))) ?>"></td>
            </tr>
            <tr>
                <td>Nur Vorschau:</td>
                <td><input type="checkbox" name="preview" value="1"<?php echo post_value('preview') ? ' checked' : '' ?>></td>
            </tr>
        </table>
        <input type="submit" value="Rechnungslauf starten">
    </form>

    <?php if (isset($preview) && $preview && is_valid_result($result)): ?>
        <h3>Vorschau</h3>
        <table>
            <tr>
                <th>Kunde</th>
                <th>Artikel</th>
                <th>Bezeichnung</th>
                <th>Menge</th>
                <th>Preis</th>
                <th>Gesamt</th>
            </tr>
            <?php 
            $summe = 0;
            while ($pos = $result->fetch_object()): 
                $gesamt = $pos->menge * $pos->preis;
                $summe += $gesamt;
            ?>
                <tr>
                    <td>
                        <?php 
                        safe_echo($pos->kunde_name);
                        if (!empty($pos->kunde_vorname)) {
                            echo ', ';
                            safe_echo($pos->kunde_vorname);
                        }
                        ?>
                    </td>
                    <td><?php safe_echo($pos->artikel) ?></td>
                    <td><?php safe_echo($pos->bezeichnung) ?></td>
                    <td><?php safe_echo($pos->menge) ?></td>
                    <td><?php safe_echo(number_format($pos->preis, 2, ',', '.')) ?> €</td>
                    <td><?php safe_echo(number_format($gesamt, 2, ',', '.')) ?> €</td>
                </tr>
            <?php endwhile; ?>
            <tr>
                <td colspan="5"><strong>Gesamtsumme:</strong></td>
                <td><strong><?php safe_echo(number_format($summe, 2, ',', '.')) ?> €</strong></td>
            </tr>
        </table>
    <?php elseif (isset($erfolg)): ?>
        <?php if ($erfolg): ?>
            <p class="success">Der Rechnungslauf wurde erfolgreich durchgeführt.</p>
            <?php if (isset($anzahl)): ?>
                <p><?php safe_echo($anzahl) ?> Rechnungen wurden erstellt.</p>
            <?php endif; ?>
        <?php else: ?>
            <p class="error">Beim Rechnungslauf ist ein Fehler aufgetreten.</p>
            <?php if (isset($error)): ?>
                <p class="error"><?php safe_echo($error) ?></p>
            <?php endif; ?>
        <?php endif; ?>
    <?php endif; ?>
</body>
</html>
