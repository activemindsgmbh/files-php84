<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
  <head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link type="text/css" rel="stylesheet" href="/default.css">
    <script type="text/javascript">
    var state = true;
    function toggle ()
    {
      state = !state;
      var arr = document.getElementsByName ("id[]");
      for (var i = 0; i < arr.length; ++i)
      {
        arr[i].checked = state;
      }
    }
    </script>
  </head>
  <body>
    <?php @include('header.inc.html')?>
    <h2>Rechnungsvorschau</h2>
    <?php if(mysql_num_rows($rleistungen)<1){?>
    <p>
      keine Leistungen
    </p>
    <?php }else{?>
    <form action="/rechnung_erstellen.php?kunde=<?php echo urlencode($kunde->kundennummer)?>&datum=<?php echo urlencode(form_value($_GET['datum']))?>" method="post">
      <table border="1">
        <tr>
          <th><input type="checkbox" onclick="toggle()" checked></th>
          <th>Artikelnummer</th>
          <th>Rechnungstext</th>
          <th>Anzahl</th>
          <th>Preis / <?php echo htmlspecialchars($kunde->waehrung)?></th>
          <th>Summe / <?php echo htmlspecialchars($kunde->waehrung)?></th>
          <th>Umsatzsteuer</th>
        </tr>
        <?php
        $brutto = 0.0;
        $netto = 0.0;
        $subtotal = array ();
        while ($leistung = mysql_fetch_object($rleistungen))
        {
          $refdate = $leistung->referenzdatum;
          if ($leistung->intervall)
          {
            $endedatum = ($leistung->endedatum ? min($leistung->endedatum, $datum) : $datum);
            $refdate = advance_date ($leistung->referenzdatum, $leistung->intervall, (int)$leistung->abgerechnet);
          }
          else
          {
            $endedatum = $refdate;
          }
          if (!array_key_exists($leistung->umsatzsteuer, $subtotal))
          {
            $subtotal[$leistung->umsatzsteuer] = 0.0;
          }
          $sub = 0;
          if ($refdate <= $endedatum && $leistung->setup && $leistung->setup !== '0.00' && !$leistung->abgerechnet)
          {
            $sum = $leistung->anzahl * $leistung->setup;
            $netto += $sum;
            $subtotal[$leistung->umsatzsteuer] += $sum;
        ?>
        <tr valign="top">
          <td><input name="id[]" type="checkbox" value="<?php echo htmlspecialchars($leistung->id)?>" checked></td>
          <td><?php echo htmlspecialchars($leistung->artikelnummer)?></td>
          <td><?php
          echo nl2br (htmlspecialchars($leistung->kommentar));
          echo '<br>Setup am ' . sprintf ('%02d.%02d.%04d', $refdate % 100, floor($refdate/100) % 100, floor($refdate / 10000));
          ?></td>
          <td align="right"><?php echo htmlspecialchars(number_format($leistung->anzahl,2,',','.'))?></td>
          <td align="right"><?php echo htmlspecialchars(number_format($leistung->setup,2,',','.'))?></td>
          <td align="right"><?php echo htmlspecialchars(number_format($sum,2,',','.'))?></td>
          <td align="right"><?php echo htmlspecialchars(str_replace('.',',',$leistung->umsatzsteuer))?> %</td>
        </tr>
        <?php
            ++$sub;
          }
          while ($refdate <= $endedatum)
          {
            $sum = $leistung->anzahl * $leistung->preis;
            $netto += $sum;
            $subtotal[$leistung->umsatzsteuer] += $sum;
        ?>
        <tr valign="top">
          <td><?php if($sub==0){?><input name="id[]" type="checkbox" value="<?php echo htmlspecialchars($leistung->id)?>" checked><?php }?></td>
          <td><?php echo htmlspecialchars($leistung->artikelnummer)?></td>
          <td><?php
          echo nl2br (htmlspecialchars($leistung->kommentar));
          if ($leistung->domain)
          {
            echo '<br>Registrierung/Verl&auml;ngerung am ' . sprintf ('%02d.%02d.%04d', $refdate % 100, floor($refdate/100) % 100, floor($refdate / 10000));
          }
          else if ($leistung->intervall)
          {
            echo '<br>' . sprintf('%02d/%04d', floor($refdate / 100) % 100, floor($refdate / 10000));
          }
          ?></td>
          <td align="right"><?php echo htmlspecialchars(number_format($leistung->anzahl,2,',','.'))?></td>
          <td align="right"><?php echo htmlspecialchars(number_format($leistung->preis,2,',','.'))?></td>
          <td align="right"><?php echo htmlspecialchars(number_format($sum,2,',','.'))?></td>
          <td align="right"><?php echo htmlspecialchars(str_replace('.',',',$leistung->umsatzsteuer))?> %</td>
        </tr>
        <?php
            $refdate = $leistung->intervall ? advance_date ($leistung->referenzdatum, $leistung->intervall, $refdate) : $endedatum + 1;
            ++$sub;
          }
        }
        ?>
      </table>
      <?php
      echo '<div>Summe netto : ' . htmlspecialchars(number_format($netto,2,',','.')) . ' ' . htmlspecialchars($kunde->waehrung) . '</div>';
      foreach ($subtotal as $key => $val)
      {
        $tax = round (($val * $key) / 100, 2);
        echo '<div>' . htmlspecialchars(str_replace('.',',',$key)) . ' % USt. : ' . htmlspecialchars(number_format($tax,2,',','.')) . ' ' . htmlspecialchars($kunde->waehrung) . '</div>';
        $brutto += $val + $tax;
      }
      echo '<div>Summe brutto : ' . htmlspecialchars(number_format($brutto,2,',','.')) . ' ' . htmlspecialchars($kunde->waehrung) . '</div>';
      ?>
      <p>
				Rechnungsdatum
				<input name="rdatum" type="text" value="<?php echo htmlspecialchars(date('d.m.Y'))?>" size="10" maxlength="13">
        <input name="" type="submit" value="Rechnung erstellen">
      </p>
    </form>
    <?php }?>
  </body>
</html>