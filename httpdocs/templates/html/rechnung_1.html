<?php require_once('_template_init.php'); ?>
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>Rechnung</title>
    <link rel="stylesheet" type="text/css" href="/default.css">
</head>
<body>
    <?php @include('header.inc.html') ?>

    <h2>Rechnung</h2>
    
    <?php if (isset($rechnung) && $rechnung): ?>
        <table>
            <tr>
                <td>Rechnungsnummer:</td>
                <td><?php safe_echo($rechnung->rechnungsnummer) ?></td>
            </tr>
            <tr>
                <td>Datum:</td>
                <td><?php safe_echo($rechnung->datum) ?></td>
            </tr>
            <tr>
                <td>Kunde:</td>
                <td>
                    <?php 
                    safe_echo($rechnung->kunde_name);
                    if (!empty($rechnung->kunde_vorname)) {
                        echo ', ';
                        safe_echo($rechnung->kunde_vorname);
                    }
                    if (!empty($rechnung->kunde_firma)) {
                        echo '<br>';
                        safe_echo($rechnung->kunde_firma);
                    }
                    ?>
                </td>
            </tr>
            <tr>
                <td>Status:</td>
                <td><?php safe_echo($rechnung->status) ?></td>
            </tr>
        </table>

        <?php if (is_valid_result($positionen)): ?>
            <h3>Positionen</h3>
            <table>
                <tr>
                    <th>Pos</th>
                    <th>Artikel</th>
                    <th>Bezeichnung</th>
                    <th>Menge</th>
                    <th>Preis</th>
                    <th>Gesamt</th>
                </tr>
                <?php 
                $summe = 0;
                while ($pos = $positionen->fetch_object()): 
                    $gesamt = $pos->menge * $pos->preis;
                    $summe += $gesamt;
                ?>
                    <tr>
                        <td><?php safe_echo($pos->position) ?></td>
                        <td><?php safe_echo($pos->artikel) ?></td>
                        <td><?php safe_echo($pos->bezeichnung) ?></td>
                        <td><?php safe_echo($pos->menge) ?></td>
                        <td><?php safe_echo(number_format($pos->preis, 2, ',', '.')) ?> €</td>
                        <td><?php safe_echo(number_format($gesamt, 2, ',', '.')) ?> €</td>
                    </tr>
                <?php endwhile; ?>
                <tr>
                    <td colspan="5"><strong>Summe:</strong></td>
                    <td><strong><?php safe_echo(number_format($summe, 2, ',', '.')) ?> €</strong></td>
                </tr>
            </table>
        <?php endif; ?>

        <?php if ($rechnung->status === 'offen'): ?>
            <form method="post">
                <input type="hidden" name="cmd" value="mark_paid">
                <input type="hidden" name="nr" value="<?php safe_echo($rechnung->rechnungsnummer) ?>">
                <input type="submit" value="Als bezahlt markieren">
            </form>
        <?php endif; ?>

        <p>
            <a href="/rechnungen.php">Zurück zur Übersicht</a>
            <a href="/rechnungsvorschau.php?nr=<?php echo safe_url($rechnung->rechnungsnummer) ?>" target="_blank">PDF-Vorschau</a>
        </p>
    <?php else: ?>
        <p>Rechnung nicht gefunden.</p>
        <p><a href="/rechnungen.php">Zurück zur Übersicht</a></p>
    <?php endif; ?>
</body>
</html>
